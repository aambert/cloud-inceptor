#!/bin/bash

set -xe

echo 'debconf debconf/frontend select Noninteractive' | debconf-set-selections

# Update and upgrade the distribution
apt-get update
apt-get -y \
    --allow-downgrades --allow-remove-essential --allow-change-held-packages \
    dist-upgrade

# Docker

curl -fsSL https://get.docker.com/gpg | sudo apt-key add -
curl -fsSL https://get.docker.com/ | sh

usermod -aG docker ubuntu

systemctl stop docker
systemctl disable docker

curl -L https://github.com/docker/compose/releases/download/1.12.0/docker-compose-`uname -s`-`uname -m` > /usr/local/bin/docker-compose
chmod 0755 /usr/local/bin/docker-compose

# Install Apache Web Server
apt-get install -y apache2 apache2-utils libapache2-mod-authnz-external pwauth
systemctl stop apache2
systemctl disable apache2

# VPN
apt-get install -y whois openvpn easy-rsa libpam-google-authenticator zip
systemctl stop openvpn
systemctl disable openvpn

curl -L https://s3.amazonaws.com/mevansam-software/openvpn/openvpn-install-2.4.0-I602.exe -o /etc/openvpn/openvpn-install-2.4.0-I602.exe

# Squid Proxy
apt-get install -y squid3
systemctl stop squid
systemctl disable squid

# Install git crypt
apt-get install -y make g++ libssl-dev openssl

git clone https://github.com/AGWA/git-crypt /tmp/git-crypt
cd /tmp/git-crypt

make
make install PREFIX=/usr/local

cd ~

set +xe
