#!/bin/bash

function parse_yaml {
   local prefix=$2
   local s='[[:space:]]*' w='[a-zA-Z0-9_]*' fs=$(echo @|tr @ '\034')
   sed -ne "s|^\($s\):|\1|" \
        -e "s|^\($s\)\($w\)$s:$s[\"']\(.*\)[\"']$s\$|\1$fs\2$fs\3|p" \
        -e "s|^\($s\)\($w\)$s:$s\(.*\)$s\$|\1$fs\2$fs\3|p" $1 |
   awk -F$fs '{
      indent = length($1)/2;
      vname[indent] = $2;
      for (i in vname) {if (i > indent) {delete vname[i]}}
      if (length($3) > 0) {
         vn=""; for (i=0; i<indent; i++) {vn=(vn)(vname[i])("_")}
         printf("%s%s%s=\"%s\"\n", "'$prefix'",vn, $2, $3);
      }
   }'
}

# This script needs to be run as root
if [[ `whoami` != "root" ]]; then 
    echo -e "\nThis script needs to be run as root.\n"
    exit 1
fi

# Install RVM
# if [ ! -e /usr/local/rvm ]; then
#     curl -sSL https://rvm.io/mpapis.asc | gpg --import -
#     curl -sSL https://get.rvm.io | bash -s stable
# fi
# export PATH="$PATH:/usr/local/rvm/bin" # Add RVM to PATH for scripting
# source "/usr/local/rvm/scripts/rvm" # Load RVM into a shell session *as a function*

# Instal Ruby
# ruby=$(which ruby)
# if [ "$ruby" == "/usr/bin/ruby" ] || [ -z "$ruby" ]; then
  
#     if [ -d /etc/apt/ ]; then
#         sudo apt-get -y install build-essential ruby ruby-dev libxml2-dev \
#             libsqlite3-dev libxslt1-dev libpq-dev libmysqlclient-dev zlib1g-dev zip
#     elif [ -d /etc/yum/ ]; then
#         sudo yum -y install gcc ruby ruby-devel mysql-devel postgresql-devel \
#             postgresql-libs sqlite-devel libxslt-devel libxml2-devel yajl-ruby
#     fi

#     rvm install 2.2
#     rvm --default use 2.2
# fi

# Install Python
# python=$(which python3)
# if [ "$python" == "/usr/bin/python3" ] || [ -z "$python" ]; then

#     if [ -d /etc/apt/ ]; then
#         sudo apt-get install python3 python3-dev
#     elif [ -d /etc/yum/ ]; then
#         echo "fedora/suse linux not supported"
#         exit 1
#     fi

#     rm -f /usr/local/bin/python
#     ln -s $(which python3) /usr/local/bin/python
# fi

# Load configuration
[ -e "/root/config.yml" ] || wget http://169.254.169.254/latest/user-data -O /root/config.yml 
eval $(parse_yaml /root/config.yml "config_")

hn=$(hostname)
cat /etc/hosts | grep "127.0.1.1" > /dev/null 2>&1
if [[ $? -ne 0 ]]; then
    sed -i "s|^127.0.0.1 .*$|127.0.0.1 localhost\n127.0.1.1 $hn|" /etc/hosts
fi
